---
import Layout from '../../layouts/Layout.astro';
import CopyButton from '../../components/CopyButton.astro';
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import { calculateReadingTime } from '../../utils/blogUtil';
import type { CollectionEntry } from 'astro:content';

interface Props {
  post: CollectionEntry<'posts'>;
}

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;

const { Content, headings } = await post.render();
const readingTime = calculateReadingTime(post.body);
const formattedDate = new Intl.DateTimeFormat('en-GB', {
  year: 'numeric',
  month: 'short',
  day: 'numeric',
}).format(new Date(post.data.date));
---

<Layout 
  title={post.data.title} 
  description={post.data.description}
  image={post.data.coverImage}
  type="article"
>
  <main class="w-full mx-auto px-6 sm:px-8 lg:px-12 py-10 bg-white dark:bg-gray-900">
    {/* Draft Banner */}
    {post.data.draft && (
      <div class="max-w-4xl mx-auto mb-6">
        <div class="bg-amber-50 dark:bg-amber-900/20 border-l-4 border-amber-500 p-4 rounded-r-lg">
          <div class="flex items-center">
            <svg class="w-5 h-5 text-amber-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
            </svg>
            <p class="text-sm font-medium text-amber-800 dark:text-amber-200">This is a draft post and may be incomplete or subject to change.</p>
          </div>
        </div>
      </div>
    )}

    <div class="max-w-4xl mx-auto">
      <header class="mb-8">
        <a
          href="/blog-index"
          class="inline-flex items-center gap-2 text-sm text-emerald-600 dark:text-emerald-400 hover:underline mb-6 transition-colors"
          aria-label="Back to blog index"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width={2} d="M15 19l-7-7 7-7" />
          </svg>
          Back to Blog
        </a>

        {/* Author and tags in bordered container */}
        <div class="mb-4 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 rounded border-2 border-amber-600 dark:border-amber-500 p-3">
          <div class="flex items-center gap-3">
            {post.data.author?.avatar && (
              <Image
                src={post.data.author.avatar}
                alt={post.data.author.name}
                width={48}
                height={48}
                class="w-12 h-12 rounded-full object-cover ring-2 ring-white dark:ring-gray-700 shadow-sm"
                loading="eager"
                decoding="async"
                format="webp"
                quality={80}
              />
            )}
            <div>
              <div class="font-medium text-gray-900 dark:text-gray-100">
                {post.data.author?.name || 'Anonymous'}
              </div>
              <div class="text-sm text-gray-600 dark:text-gray-300 mt-0.5">
                <time datetime={post.data.date.toISOString()}>
                  {formattedDate}
                </time>
                <span aria-hidden="true" class="mx-1.5">•</span>
                <span>{readingTime}</span>
              </div>
            </div>
          </div>

          <div class="flex gap-2 flex-wrap">
            {post.data.tags && post.data.tags.map((tag) => (
              <a 
                href={`/blog-index?tag=${encodeURIComponent(tag)}`}
                class="text-xs bg-emerald-100 dark:bg-emerald-900 text-emerald-800 dark:text-emerald-200 px-3 py-1 rounded-full shadow-sm hover:bg-emerald-200 dark:hover:bg-emerald-800 transition-colors"
              >
                {tag}
              </a>
            ))}
          </div>
        </div>

        {/* Hero Image */}
        {post.data.coverImage && (
          <figure class="mb-6 mt-4">
            <Image
              src={post.data.coverImage}
              alt={post.data.title}
              width={1200}
              height={600}
              class="w-full rounded-lg object-cover h-56 md:h-64 lg:h-72 shadow-lg"
              loading="eager"
              decoding="async"
              fetchpriority="high"
              format="webp"
              quality={80}
            />
            <figcaption class="mt-3 text-sm text-gray-600 dark:text-gray-400">
              {post.data.title} — photo by {post.data.author?.name || 'Unknown'}
            </figcaption>
          </figure>
        )}

        <h1 class="mt-6 text-3xl md:text-4xl lg:text-5xl font-extrabold text-gray-900 dark:text-gray-100 leading-tight">
          {post.data.title}
        </h1>
      </header>

      {/* Table of Contents for long posts */}
      {headings.length > 2 && (
        <nav class="mb-8 max-w-prose mx-auto" aria-label="Table of contents">
          <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
            <h2 class="text-sm font-semibold text-gray-900 dark:text-gray-100 mb-3">
              Contents
            </h2>
            <ul class="space-y-2 list-none pl-0">
              {headings.filter(h => h.depth <= 3).map((heading) => (
                <li style={`margin-left: ${(heading.depth - 2) * 1}rem`} class="my-0">
                  <a
                    href={`#${heading.slug}`}
                    class="text-xl text-gray-700 dark:text-gray-300 hover:text-emerald-600 dark:hover:text-emerald-400 transition-colors hover:underline block py-1"
                  >
                    {heading.text}
                  </a>
                </li>
              ))}
            </ul>
          </div>
        </nav>
      )}

      {/* Content */}
      <article class="prose prose-xl lg:prose-2xl max-w-none mx-auto mt-8 text-gray-900 dark:text-gray-100" id="blog-content">
        <Content />
      </article>

      <!-- Footer -->
      <footer class="mt-12 border-t border-gray-200 dark:border-gray-700 pt-6 text-sm text-gray-500 dark:text-gray-400">
        <div class="flex flex-col sm:flex-row sm:justify-between gap-3">
          <div class="opacity-90 text-gray-700 dark:text-gray-300">
            Tags: {post.data.tags?.join(', ') || '—'}
          </div>
          <div class="text-right text-gray-700 dark:text-gray-300">
            Photo credits: {post.data.author?.name || 'Unknown'} • {formattedDate}
          </div>
        </div>
        <div class="mt-6 text-center">
          <a
            href="/blog-index"
            class="inline-flex items-center gap-2 text-sm text-emerald-600 dark:text-emerald-400 hover:underline font-medium transition-colors"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            All posts
          </a>
        </div>
      </footer>
    </div>
  </main>
  <CopyButton />
</Layout>

<style is:global>
  /* Fix prose styles for better rendering */
  .prose {
    color: inherit;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }
  
  .prose h2,
  .prose h3,
  .prose h4 {
    font-family: ui-serif, Georgia, Cambria, "Times New Roman", Times, serif;
    font-weight: 600;
    margin-top: 2rem;
    margin-bottom: 1rem;
    line-height: 1.3;
  }

  :root .prose h2,
  :root .prose h3,
  :root .prose h4 {
    color: rgb(17 24 39);
  }
  
  :is(.dark, [data-theme="dark"]) .prose h2,
  :is(.dark, [data-theme="dark"]) .prose h3,
  :is(.dark, [data-theme="dark"]) .prose h4 {
    color: rgb(243 244 246) !important;
  }

  @media (prefers-color-scheme: dark) {
    :root:not(.light) .prose h2,
    :root:not(.light) .prose h3,
    :root:not(.light) .prose h4 {
      color: rgb(243 244 246) !important;
    }
  }
  
  .prose h2 {
    font-size: 2.25rem;
  }
  
  .prose h3 {
    font-size: 1.75rem;
  }
  
  .prose p {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 1.25rem;
    line-height: 1.8;
    margin-top: 1.25rem;
    margin-bottom: 1.25rem;
  }

  :root .prose p {
    color: rgb(31 41 55);
  }
  
  :is(.dark, [data-theme="dark"]) .prose p {
    color: rgb(243 244 246) !important;
  }

  @media (prefers-color-scheme: dark) {
    :root:not(.light) .prose p {
      color: rgb(243 244 246) !important;
    }
  }
  
  .prose a {
    color: rgb(5 150 105);
    text-decoration: none;
    font-weight: 500;
  }
  
  :is(.dark, [data-theme="dark"]) .prose a {
    color: rgb(52 211 153);
  }
  
  .prose a:hover {
    text-decoration: underline;
  }
  
  .prose ul,
  .prose ol {
    padding-left: 1.5rem;
    margin-top: 1rem;
    margin-bottom: 1rem;
  }
  
  .prose li {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 1.25rem;
    line-height: 1.8;
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
  }

  :root .prose li {
    color: rgb(31 41 55);
  }
  
  :is(.dark, [data-theme="dark"]) .prose li {
    color: rgb(243 244 246) !important;
  }

  @media (prefers-color-scheme: dark) {
    :root:not(.light) .prose li {
      color: rgb(243 244 246) !important;
    }
  }
  
  .prose ul {
    list-style-type: disc;
  }
  
  .prose ol {
    list-style-type: decimal;
  }
  
  .prose code {
    color: rgb(5 150 105);
    background-color: rgb(243 244 246);
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.95em;
    font-weight: 600;
    font-family: ui-monospace, "SF Mono", "Cascadia Code", "Roboto Mono", "Fira Code", Menlo, Consolas, "Liberation Mono", monospace;
  }
  
  :is(.dark, [data-theme="dark"]) .prose code {
    color: rgb(52 211 153);
    background-color: rgb(31 41 55);
  }
  
  .prose pre {
    position: relative;
    background-color: rgb(17 24 39);
    color: rgb(243 244 246);
    border-radius: 0.5rem;
    padding: 3rem 1rem 1rem 1rem;
    overflow-x: auto;
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid rgb(55 65 81);
  }
  
  :is(.dark, [data-theme="dark"]) .prose pre {
    background-color: rgb(15 23 42);
    border-color: rgb(51 65 85);
  }
  
  .prose pre code {
    background-color: transparent;
    color: inherit;
    padding: 0;
    font-weight: normal;
    font-size: 1.125rem;
    line-height: 1.8;
    font-family: ui-monospace, "SF Mono", "Cascadia Code", "Roboto Mono", "Fira Code", Menlo, Consolas, "Liberation Mono", monospace;
  }
  
  .code-block-wrapper {
    position: relative;
  }
  
  .copy-button {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    padding: 0.375rem 0.75rem;
    background-color: rgb(55 65 81);
    color: rgb(243 244 246);
    border: 1px solid rgb(75 85 99);
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.375rem;
    z-index: 10;
  }
  
  .copy-button:hover {
    background-color: rgb(75 85 99);
    border-color: rgb(107 114 128);
  }
  
  .copy-button.copied {
    background-color: rgb(16 185 129);
    border-color: rgb(16 185 129);
    color: white;
  }
  
  .copy-button svg {
    width: 1rem;
    height: 1rem;
  }
  
  .prose blockquote {
    border-left: 4px solid rgb(16 185 129);
    padding-left: 1rem;
    font-style: italic;
    font-size: 1.25rem;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    color: rgb(75 85 99);
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
  }
  
  :is(.dark, [data-theme="dark"]) .prose blockquote {
    color: rgb(229 231 235) !important;
  }
  
  .prose img {
    border-radius: 0.5rem;
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
  }
  
  .prose strong {
    font-weight: 600;
  }

  :root .prose strong {
    color: rgb(17 24 39);
  }
  
  :is(.dark, [data-theme="dark"]) .prose strong {
    color: rgb(243 244 246) !important;
  }

  @media (prefers-color-scheme: dark) {
    :root:not(.light) .prose strong {
      color: rgb(243 244 246) !important;
    }
  }

  .prose table {
    border: 1px solid rgb(229 231 235);
    width: 100%;
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
  }

  :is(.dark, [data-theme="dark"]) .prose table {
    border-color: rgb(75 85 99);
  }

  .prose th {
    background-color: rgb(249 250 251);
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
  }

  :is(.dark, [data-theme="dark"]) .prose th {
    background-color: rgb(31 41 55);
    color: rgb(243 244 246);
  }

  .prose td {
    padding: 0.75rem;
    border-top: 1px solid rgb(229 231 235);
  }

  :is(.dark, [data-theme="dark"]) .prose td {
    border-top-color: rgb(75 85 99);
    color: rgb(243 244 246);
  }

  @media (prefers-color-scheme: dark) {
    :root:not(.light) .prose td,
    :root:not(.light) .prose th {
      color: rgb(243 244 246) !important;
    }
  }
</style>